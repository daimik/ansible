---
# Ansible Playbook: Update all Docker containers
# Pulls latest images for all running containers, recreates them
# with the same configuration (ports, volumes, env, etc.)
# Replaces Watchtower with a controlled, scheduled approach.
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://gotify/)
#   gotify_token  - Gotify application token

- name: Update all Docker containers
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5
    prune_old_images: true
    # Containers to skip (never update these)
    exclude_containers:
      - watchtower
      - ansible-semaphoreui-1
      - ansible-semaphoreui_db-1

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Get list of all running containers
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get all running container names
      ansible.builtin.shell: docker ps -a --filter "status=running" --format json | python3 -c "import sys,json; [print(json.loads(l)['Names']) for l in sys.stdin]"
      register: _containers_raw
      changed_when: false

    - name: Build running containers list (excluding skipped)
      ansible.builtin.set_fact:
        _running_containers: "{{ _containers_raw.stdout_lines | difference(exclude_containers) | sort }}"

    - name: Display running containers
      ansible.builtin.debug:
        msg: "Found {{ _running_containers | length }} running containers: {{ _running_containers | join(', ') }}"

    - name: Skip if no containers running
      ansible.builtin.meta: end_host
      when: _running_containers | length == 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. Deploy update helper script
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Create docker update helper script
      ansible.builtin.shell: echo 'IyEvYmluL2Jhc2gKQUNUSU9OPSIkMSIKQ09OVEFJTkVSPSIkMiIKCmNhc2UgIiRBQ1RJT04iIGluCiAgZ2V0LWltYWdlKQogICAgZG9ja2VyIGluc3BlY3QgLS1mb3JtYXQgJ3t7Lk5hbWV9fXx7ey5Db25maWcuSW1hZ2V9fXx7ey5JbWFnZX19JyAiJENPTlRBSU5FUiIgfCBzZWQgJ3N8Xi98fCcKICAgIDs7CiAgZ2V0LXJ1bi1jb25maWcpCiAgICBkb2NrZXIgaW5zcGVjdCAiJENPTlRBSU5FUiIgfCBweXRob24zIDw8ICdQWUVPRicKaW1wb3J0IHN5cywganNvbgoKYyA9IGpzb24ubG9hZHMoc3lzLnN0ZGluLnJlYWQoKSlbMF0KYXJncyA9IFtdCgojIE5hbWUKbmFtZSA9IGNbJ05hbWUnXS5sc3RyaXAoJy8nKQphcmdzLmFwcGVuZCgnLS1uYW1lICcgKyBuYW1lKQoKIyBWb2x1bWVzL0JpbmRzCmZvciBiIGluIChjLmdldCgnSG9zdENvbmZpZycsIHt9KS5nZXQoJ0JpbmRzJykgb3IgW10pOgogICAgYXJncy5hcHBlbmQoJy12ICcgKyBiKQoKIyBQb3J0cwpwb3J0cyA9IGMuZ2V0KCdIb3N0Q29uZmlnJywge30pLmdldCgnUG9ydEJpbmRpbmdzJykgb3Ige30KZm9yIGNvbnRhaW5lcl9wb3J0LCBiaW5kaW5ncyBpbiBwb3J0cy5pdGVtcygpOgogICAgaWYgYmluZGluZ3M6CiAgICAgICAgZm9yIGJpbmQgaW4gYmluZGluZ3M6CiAgICAgICAgICAgIGhvc3RfaXAgPSBiaW5kLmdldCgnSG9zdElwJywgJycpCiAgICAgICAgICAgIGhvc3RfcG9ydCA9IGJpbmQuZ2V0KCdIb3N0UG9ydCcsICcnKQogICAgICAgICAgICBpZiBob3N0X2lwIGFuZCBob3N0X2lwIG5vdCBpbiAoJzAuMC4wLjAnLCAnOjonLCAnJyk6CiAgICAgICAgICAgICAgICBhcmdzLmFwcGVuZCgnLXAge306e306e30nLmZvcm1hdChob3N0X2lwLCBob3N0X3BvcnQsIGNvbnRhaW5lcl9wb3J0KSkKICAgICAgICAgICAgZWxpZiBob3N0X3BvcnQ6CiAgICAgICAgICAgICAgICBhcmdzLmFwcGVuZCgnLXAge306e30nLmZvcm1hdChob3N0X3BvcnQsIGNvbnRhaW5lcl9wb3J0KSkKCiMgRW52aXJvbm1lbnQgLSBza2lwIHN5c3RlbS9ydW50aW1lIHZhcnMKc2tpcF9wcmVmaXhlcyA9ICgKICAgICdQQVRIPScsICdIT01FPScsICdURVJNPScsICdIT1NUTkFNRT0nLCAnUFMxPScsCiAgICAnUzZfQ01EX1dBSVQnLCAnUzZfVkVSQk9TSVRZJywgJ1M2X1NUQUdFMicsCiAgICAnVklSVFVBTF9FTlY9JywgJ1BIUF9JTklfU0NBTl9ESVI9JywgJ0xTSU9fRklSU1RfUEFSVFk9JywKICAgICdMQU5HPScsICdMQ19BTEw9JywgJ0xBTkdVQUdFPScsICdERUJJQU5fRlJPTlRFTkQ9JywKICAgICdHUEdfS0VZPScsICdQWVRIT05fVkVSU0lPTj0nLCAnUFlUSE9OX1BJUF9WRVJTSU9OPScsCiAgICAnR09QQVRIPScsICdHT1NVX1ZFUlNJT049JywgJ0pBVkFfSE9NRT0nLAogICAgJ05PREVfVkVSU0lPTj0nLCAnWUFSTl9WRVJTSU9OPScsICdOUE1fQ09ORklHJywKICAgICdNWVNRTF9NQUpPUj0nLCAnTVlTUUxfVkVSU0lPTj0nLCAnTVlTUUxfU0hFTEwnLAogICAgJ01BUklBREJfTUFKT1I9JywgJ01BUklBREJfVkVSU0lPTj0nLAogICAgJ1BHX01BSk9SPScsICdQR19WRVJTSU9OPScsICdQR19TSEEyNTY9JywgJ1BHREFUQT0nLAogICAgJ0RPQ0tFUl9JTkZMVVhEQicsICdJTkZMVVhEQl9WRVJTSU9OPScsCiAgICAnR0ZfUEFUSFMnLCAnTkdJTlhfVkVSU0lPTj0nLAogICAgJ1pCWF8nLCAnTUFQSV8nLCAnVElOSV9WRVJTSU9OPScsCikKZm9yIGVudiBpbiAoYy5nZXQoJ0NvbmZpZycsIHt9KS5nZXQoJ0VudicpIG9yIFtdKToKICAgIGlmIG5vdCBhbnkoZW52LnN0YXJ0c3dpdGgocCkgZm9yIHAgaW4gc2tpcF9wcmVmaXhlcyk6CiAgICAgICAgIyBVc2Ugc2luZ2xlIHF1b3RlcywgZXNjYXBlIGFueSBzaW5nbGUgcXVvdGVzIGluIHZhbHVlCiAgICAgICAgc2FmZSA9IGVudi5yZXBsYWNlKCInIiwgIidcIidcIiciKQogICAgICAgIGFyZ3MuYXBwZW5kKCItZSAne30nIi5mb3JtYXQoc2FmZSkpCgojIFJlc3RhcnQgcG9saWN5CnJwID0gYy5nZXQoJ0hvc3RDb25maWcnLCB7fSkuZ2V0KCdSZXN0YXJ0UG9saWN5Jywge30pCnJlc3RhcnQgPSBycC5nZXQoJ05hbWUnLCAnJykKaWYgcmVzdGFydCBhbmQgcmVzdGFydCBub3QgaW4gKCdubycsICcnKToKICAgIG1heF9yZXRyeSA9IHJwLmdldCgnTWF4aW11bVJldHJ5Q291bnQnLCAwKQogICAgaWYgcmVzdGFydCA9PSAnb24tZmFpbHVyZScgYW5kIG1heF9yZXRyeSA+IDA6CiAgICAgICAgYXJncy5hcHBlbmQoJy0tcmVzdGFydCB7fTp7fScuZm9ybWF0KHJlc3RhcnQsIG1heF9yZXRyeSkpCiAgICBlbHNlOgogICAgICAgIGFyZ3MuYXBwZW5kKCctLXJlc3RhcnQgJyArIHJlc3RhcnQpCgojIE5ldHdvcmsKbmV0ID0gYy5nZXQoJ0hvc3RDb25maWcnLCB7fSkuZ2V0KCdOZXR3b3JrTW9kZScsICcnKQppZiBuZXQgYW5kIG5ldCBub3QgaW4gKCdkZWZhdWx0JywgJ2JyaWRnZScpOgogICAgYXJncy5hcHBlbmQoJy0tbmV0d29yayAnICsgbmV0KQoKIyBIb3N0bmFtZSAtIG9ubHkgaWYgY3VzdG9tCmhvc3RuYW1lID0gYy5nZXQoJ0NvbmZpZycsIHt9KS5nZXQoJ0hvc3RuYW1lJywgJycpCmNpZCA9IGMuZ2V0KCdJZCcsICcnKVs6MTJdCmlmIGhvc3RuYW1lIGFuZCBob3N0bmFtZSAhPSBjaWQgYW5kIGhvc3RuYW1lICE9IG5hbWU6CiAgICBwYXNzICAjIHNraXAgYXV0by1nZW5lcmF0ZWQgaG9zdG5hbWVzCgojIFByaXZpbGVnZWQKaWYgYy5nZXQoJ0hvc3RDb25maWcnLCB7fSkuZ2V0KCdQcml2aWxlZ2VkJyk6CiAgICBhcmdzLmFwcGVuZCgnLS1wcml2aWxlZ2VkJykKCiMgRGV2aWNlcwpmb3IgZGV2IGluIChjLmdldCgnSG9zdENvbmZpZycsIHt9KS5nZXQoJ0RldmljZXMnKSBvciBbXSk6CiAgICBhcmdzLmFwcGVuZCgnLS1kZXZpY2Uge306e30nLmZvcm1hdChkZXZbJ1BhdGhPbkhvc3QnXSwgZGV2WydQYXRoSW5Db250YWluZXInXSkpCgojIENhcCBhZGQKZm9yIGNhcCBpbiAoYy5nZXQoJ0hvc3RDb25maWcnLCB7fSkuZ2V0KCdDYXBBZGQnKSBvciBbXSk6CiAgICBhcmdzLmFwcGVuZCgnLS1jYXAtYWRkICcgKyBjYXApCgojIFBJRCBtb2RlCnBpZCA9IGMuZ2V0KCdIb3N0Q29uZmlnJywge30pLmdldCgnUGlkTW9kZScsICcnKQppZiBwaWQ6CiAgICBhcmdzLmFwcGVuZCgnLS1waWQgJyArIHBpZCkKCiMgTGFiZWxzIC0gc2tpcCBjb21wb3NlLCBPQ0ksIGFuZCBtYWludGFpbmVyIGxhYmVscwpza2lwX2xhYmVsX3ByZWZpeGVzID0gKCdjb20uZG9ja2VyLmNvbXBvc2UuJywgJ29yZy5vcGVuY29udGFpbmVycy4nLCAnZGVza3RvcC5kb2NrZXIuJykKc2tpcF9sYWJlbF9leGFjdCA9ICgnbWFpbnRhaW5lcicsKQpmb3IgaywgdiBpbiAoYy5nZXQoJ0NvbmZpZycsIHt9KS5nZXQoJ0xhYmVscycpIG9yIHt9KS5pdGVtcygpOgogICAgaWYgYW55KGsuc3RhcnRzd2l0aChwKSBmb3IgcCBpbiBza2lwX2xhYmVsX3ByZWZpeGVzKToKICAgICAgICBjb250aW51ZQogICAgaWYgayBpbiBza2lwX2xhYmVsX2V4YWN0OgogICAgICAgIGNvbnRpbnVlCiAgICBzYWZlX3YgPSB2LnJlcGxhY2UoIiciLCAiJ1wiJ1wiJyIpCiAgICBhcmdzLmFwcGVuZCgiLWwgJ3t9PXt9JyIuZm9ybWF0KGssIHNhZmVfdikpCgojIEltYWdlCmFyZ3MuYXBwZW5kKCctZCAnICsgY1snQ29uZmlnJ11bJ0ltYWdlJ10pCgojIENvbW1hbmQgKG9ubHkgaWYgZXhwbGljaXRseSBzZXQsIG5vdCBmcm9tIGltYWdlIGRlZmF1bHQpCiMgV2Ugc2tpcCBDbWQgaWYgaXQgbWF0Y2hlcyB0aGUgaW1hZ2UgZGVmYXVsdCB0byBhdm9pZCBkdXBsaWNhdGlvbgpjbWQgPSBjLmdldCgnQ29uZmlnJywge30pLmdldCgnQ21kJykKaWYgY21kOgogICAgYXJncy5hcHBlbmQoJyAnLmpvaW4oY21kKSkKCnByaW50KCcgJy5qb2luKGFyZ3MpKQpQWUVPRgogICAgOzsKICBjaGVjay1zdGF0dXMpCiAgICBkb2NrZXIgcHMgLS1maWx0ZXIgIm5hbWU9XiR7Q09OVEFJTkVSfSQiIC0tZm9ybWF0ICd7ey5TdGF0dXN9fScKICAgIDs7CmVzYWMK' | base64 -d > /tmp/docker-update-helper.sh && chmod +x /tmp/docker-update-helper.sh
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. Get current image digests for comparison
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get current image info per container
      ansible.builtin.command: /tmp/docker-update-helper.sh get-image {{ item }}
      loop: "{{ _running_containers }}"
      register: _container_images
      changed_when: false

    - name: Build container image map
      ansible.builtin.set_fact:
        _container_map: >-
          {{ _container_map | default({}) | combine({
            item.stdout.split('|')[0]: {
              'image': item.stdout.split('|')[1],
              'old_digest': item.stdout.split('|')[2]
            }
          }) }}
      loop: "{{ _container_images.results }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. Pull latest images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get unique images to pull
      ansible.builtin.set_fact:
        _unique_images: "{{ _container_map.values() | map(attribute='image') | unique | list }}"

    - name: Display images to pull
      ansible.builtin.debug:
        msg: "Pulling {{ _unique_images | length }} unique images: {{ _unique_images | join(', ') }}"

    - name: Pull latest images
      ansible.builtin.command: "docker pull {{ item }}"
      loop: "{{ _unique_images }}"
      register: _pull_results
      changed_when: "'Downloaded newer image' in item.stdout | default('') or 'Pull complete' in item.stdout | default('')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. Check which containers need updating
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get new image digests after pull
      ansible.builtin.shell: "docker image inspect {{ item.value.image }} | python3 -c \"import sys,json; print(json.loads(sys.stdin.read())[0]['Id'])\""
      loop: "{{ _container_map | dict2items }}"
      register: _new_digests
      changed_when: false

    - name: Build update list
      ansible.builtin.set_fact:
        _containers_to_update: >-
          {{ _containers_to_update | default([]) +
            ([item.item.key] if item.stdout != _container_map[item.item.key].old_digest else [])
          }}
      loop: "{{ _new_digests.results }}"

    - name: Set update list to empty if undefined
      ansible.builtin.set_fact:
        _containers_to_update: "{{ _containers_to_update | default([]) }}"

    - name: Display containers that need updating
      ansible.builtin.debug:
        msg: >-
          {{ _containers_to_update | length }} container(s) need updating:
          {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None â€” all images are latest' }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. Recreate containers with new images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get full container run config
      ansible.builtin.command: /tmp/docker-update-helper.sh get-run-config {{ item }}
      loop: "{{ _containers_to_update }}"
      register: _container_configs
      changed_when: false
      when: _containers_to_update | length > 0

    - name: Stop old container
      ansible.builtin.command: docker stop {{ item.item }}
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: _containers_to_update | length > 0

    - name: Remove old container
      ansible.builtin.command: docker rm {{ item.item }}
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: _containers_to_update | length > 0

    - name: Recreate container with new image
      ansible.builtin.shell: "docker run {{ item.stdout | trim }}"
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      register: _recreate_results
      when: _containers_to_update | length > 0

    - name: Verify containers are running
      ansible.builtin.command: /tmp/docker-update-helper.sh check-status {{ item }}
      loop: "{{ _containers_to_update }}"
      register: _verify_results
      failed_when: "'Up' not in _verify_results.stdout"
      changed_when: false
      when: _containers_to_update | length > 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. Cleanup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Prune dangling images
      ansible.builtin.command: docker image prune -f
      register: _prune_result
      changed_when: "'Total reclaimed space: 0B' not in _prune_result.stdout"
      when: prune_old_images

    - name: Remove helper script
      ansible.builtin.file:
        path: /tmp/docker-update-helper.sh
        state: absent

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8. Gotify Notification
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Ensure curl is installed
      ansible.builtin.apt:
        name: curl
        state: present

    - name: Build Gotify notification metadata
      ansible.builtin.set_fact:
        _gotify_title: >-
          {{ 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” ' +
             (_containers_to_update | length | string) + ' container(s) updated'
             if _containers_to_update | length > 0
             else 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” All containers up to date' }}
        _gotify_priority: "{{ 6 if _containers_to_update | length > 0 else gotify_priority }}"

    - name: Build Gotify message body
      ansible.builtin.set_fact:
        _gotify_message: >-
          ðŸ–¥ï¸ **Host:** {{ ansible_hostname }}\n\nðŸŒ
          **IP:** {{ ansible_default_ipv4.address }}\n\nðŸ³
          **Containers running:** {{ _running_containers | length }}\n\nðŸ“¦
          **Updated:** {{ _containers_to_update | length }}\n\n{{
          'ðŸ”„ **Updated containers:**\n' + _containers_to_update | join(', ') + '\n\n'
          if _containers_to_update | length > 0
          else '' }}---\n\n{{
          'âœ… **All containers recreated and running**'
          if _containers_to_update | length > 0
          else 'âœ… **All images are already latest**' }}

    - name: Send Gotify notification
      ansible.builtin.shell: |
        cat <<'PAYLOAD' | curl -s -m 15 -o /dev/null -w "%{http_code}" \
          -X POST "{{ gotify_url }}message" \
          -H "X-Gotify-Key: {{ gotify_token }}" \
          -H "Content-Type: application/json" \
          -d @-
        {
          "title": "{{ _gotify_title | trim }}",
          "message": "{{ _gotify_message | trim }}",
          "priority": {{ _gotify_priority }},
          "extras": {"client::display": {"contentType": "text/markdown"}}
        }
        PAYLOAD
      register: gotify_response
      changed_when: false
      failed_when: gotify_response.stdout != "200"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9. Final Status
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "Total containers: {{ _running_containers | length }}"
          - "Containers updated: {{ _containers_to_update | length }}"
          - "Updated: {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None' }}"
          - "Excluded: {{ exclude_containers | join(', ') }}"
          - "Images pruned: {{ 'Yes' if _prune_result.changed | default(false) else 'No' }}"
