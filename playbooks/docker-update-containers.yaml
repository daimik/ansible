---
# Ansible Playbook: Update all Docker containers
# Pulls latest images for all running containers, recreates them
# with the same configuration (ports, volumes, env, etc.)
# Replaces Watchtower with a controlled, scheduled approach.
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://gotify/)
#   gotify_token  - Gotify application token

- name: Update all Docker containers
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5
    prune_old_images: true
    # Containers to skip (never update these)
    exclude_containers:
      - watchtower

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Get list of all running containers
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get all running container names
      ansible.builtin.shell: docker ps -a --filter "status=running" --format json | python3 -c "import sys,json; [print(json.loads(l)['Names']) for l in sys.stdin]"
      register: _containers_raw
      changed_when: false

    - name: Build running containers list (excluding skipped)
      ansible.builtin.set_fact:
        _running_containers: "{{ _containers_raw.stdout_lines | difference(exclude_containers) | sort }}"

    - name: Display running containers
      ansible.builtin.debug:
        msg: "Found {{ _running_containers | length }} running containers: {{ _running_containers | join(', ') }}"

    - name: Skip if no containers running
      ansible.builtin.meta: end_host
      when: _running_containers | length == 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. Deploy update helper script
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Create docker update helper script
      ansible.builtin.copy:
        dest: /tmp/docker-update-helper.sh
        mode: '0755'
        content: |
          #!/bin/bash
          # Usage: docker-update-helper.sh <action> <container_name>
          ACTION="$1"
          CONTAINER="$2"

          case "$ACTION" in
            get-image)
              # Returns: container_name|image|image_digest
              docker inspect --format '{{.Name}}|{{.Config.Image}}|{{.Image}}' "$CONTAINER" | sed 's|^/||'
              ;;
            get-image-id)
              # Returns image ID for a given image name
              IMAGE="$2"
              docker inspect --format '{{.Id}}' "$IMAGE" 2>/dev/null
              ;;
            get-run-config)
              # Reconstructs docker run command from container inspection
              docker inspect --format '
              --name {{.Name}}
              {{range .HostConfig.Binds}}-v {{.}} {{end}}
              {{range $k, $v := .HostConfig.PortBindings}}{{range $v}}-p {{if .HostIP}}{{.HostIP}}:{{end}}{{.HostPort}}:{{$k}} {{end}}{{end}}
              {{range .Config.Env}}-e "{{.}}" {{end}}
              {{if .HostConfig.RestartPolicy.Name}}--restart {{.HostConfig.RestartPolicy.Name}}{{end}}
              {{if .HostConfig.NetworkMode}}--network {{.HostConfig.NetworkMode}}{{end}}
              {{if .Config.Hostname}}--hostname {{.Config.Hostname}}{{end}}
              {{if .HostConfig.Privileged}}--privileged{{end}}
              {{range .HostConfig.Devices}}--device {{.PathOnHost}}:{{.PathInContainer}} {{end}}
              {{range .HostConfig.CapAdd}}--cap-add {{.}} {{end}}
              {{if .HostConfig.PidMode}}--pid {{.HostConfig.PidMode}}{{end}}
              {{range $k, $v := .Config.Labels}}-l "{{$k}}={{$v}}" {{end}}
              -d {{.Config.Image}}
              {{if .Config.Cmd}}{{range .Config.Cmd}}{{.}} {{end}}{{end}}
              ' "$CONTAINER" | sed 's|--name /|--name |' | tr -s ' \n' ' ' | sed 's/^ *//;s/ *$//'
              ;;
            check-status)
              docker ps --filter "name=^${CONTAINER}$" --format '{{.Status}}'
              ;;
          esac

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. Get current image digests for comparison
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get current image info per container
      ansible.builtin.command: /tmp/docker-update-helper.sh get-image {{ item }}
      loop: "{{ _running_containers }}"
      register: _container_images
      changed_when: false

    - name: Build container image map
      ansible.builtin.set_fact:
        _container_map: >-
          {{ _container_map | default({}) | combine({
            item.stdout.split('|')[0]: {
              'image': item.stdout.split('|')[1],
              'old_digest': item.stdout.split('|')[2]
            }
          }) }}
      loop: "{{ _container_images.results }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. Pull latest images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get unique images to pull
      ansible.builtin.set_fact:
        _unique_images: "{{ _container_map.values() | map(attribute='image') | unique | list }}"

    - name: Display images to pull
      ansible.builtin.debug:
        msg: "Pulling {{ _unique_images | length }} unique images: {{ _unique_images | join(', ') }}"

    - name: Pull latest images
      ansible.builtin.command: "docker pull {{ item }}"
      loop: "{{ _unique_images }}"
      register: _pull_results
      changed_when: "'Downloaded newer image' in item.stdout | default('') or 'Pull complete' in item.stdout | default('')"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. Check which containers need updating
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get new image digests after pull
      ansible.builtin.shell: "docker image inspect {{ item.value.image }} | python3 -c \"import sys,json; print(json.loads(sys.stdin.read())[0]['Id'])\""
      loop: "{{ _container_map | dict2items }}"
      register: _new_digests
      changed_when: false

    - name: Build update list
      ansible.builtin.set_fact:
        _containers_to_update: >-
          {{ _containers_to_update | default([]) +
            ([item.item.key] if item.stdout != _container_map[item.item.key].old_digest else [])
          }}
      loop: "{{ _new_digests.results }}"

    - name: Set update list to empty if undefined
      ansible.builtin.set_fact:
        _containers_to_update: "{{ _containers_to_update | default([]) }}"

    - name: Display containers that need updating
      ansible.builtin.debug:
        msg: >-
          {{ _containers_to_update | length }} container(s) need updating:
          {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None â€” all images are latest' }}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. Recreate containers with new images
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Get full container run config
      ansible.builtin.command: /tmp/docker-update-helper.sh get-run-config {{ item }}
      loop: "{{ _containers_to_update }}"
      register: _container_configs
      changed_when: false
      when: _containers_to_update | length > 0

    - name: Stop old container
      ansible.builtin.command: docker stop {{ item.item }}
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: _containers_to_update | length > 0

    - name: Remove old container
      ansible.builtin.command: docker rm {{ item.item }}
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: _containers_to_update | length > 0

    - name: Recreate container with new image
      ansible.builtin.shell: "docker run {{ item.stdout | trim }}"
      loop: "{{ _container_configs.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      register: _recreate_results
      when: _containers_to_update | length > 0

    - name: Verify containers are running
      ansible.builtin.command: /tmp/docker-update-helper.sh check-status {{ item }}
      loop: "{{ _containers_to_update }}"
      register: _verify_results
      failed_when: "'Up' not in _verify_results.stdout"
      changed_when: false
      when: _containers_to_update | length > 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. Cleanup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Prune dangling images
      ansible.builtin.command: docker image prune -f
      register: _prune_result
      changed_when: "'Total reclaimed space: 0B' not in _prune_result.stdout"
      when: prune_old_images

    - name: Remove helper script
      ansible.builtin.file:
        path: /tmp/docker-update-helper.sh
        state: absent

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8. Gotify Notification
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Ensure curl is installed
      ansible.builtin.apt:
        name: curl
        state: present

    - name: Build Gotify notification metadata
      ansible.builtin.set_fact:
        _gotify_title: >-
          {{ 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” ' +
             (_containers_to_update | length | string) + ' container(s) updated'
             if _containers_to_update | length > 0
             else 'ðŸ³ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” All containers up to date' }}
        _gotify_priority: "{{ 6 if _containers_to_update | length > 0 else gotify_priority }}"

    - name: Build Gotify message body
      ansible.builtin.set_fact:
        _gotify_message: >-
          ðŸ–¥ï¸ **Host:** {{ ansible_hostname }}\n\nðŸŒ
          **IP:** {{ ansible_default_ipv4.address }}\n\nðŸ³
          **Containers running:** {{ _running_containers | length }}\n\nðŸ“¦
          **Updated:** {{ _containers_to_update | length }}\n\n{{
          'ðŸ”„ **Updated containers:**\n' + _containers_to_update | join(', ') + '\n\n'
          if _containers_to_update | length > 0
          else '' }}---\n\n{{
          'âœ… **All containers recreated and running**'
          if _containers_to_update | length > 0
          else 'âœ… **All images are already latest**' }}

    - name: Send Gotify notification
      ansible.builtin.shell: |
        cat <<'PAYLOAD' | curl -s -m 15 -o /dev/null -w "%{http_code}" \
          -X POST "{{ gotify_url }}message" \
          -H "X-Gotify-Key: {{ gotify_token }}" \
          -H "Content-Type: application/json" \
          -d @-
        {
          "title": "{{ _gotify_title | trim }}",
          "message": "{{ _gotify_message | trim }}",
          "priority": {{ _gotify_priority }},
          "extras": {"client::display": {"contentType": "text/markdown"}}
        }
        PAYLOAD
      register: gotify_response
      changed_when: false
      failed_when: gotify_response.stdout != "200"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9. Final Status
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "Total containers: {{ _running_containers | length }}"
          - "Containers updated: {{ _containers_to_update | length }}"
          - "Updated: {{ _containers_to_update | join(', ') if _containers_to_update | length > 0 else 'None' }}"
          - "Excluded: {{ exclude_containers | join(', ') }}"
          - "Images pruned: {{ 'Yes' if _prune_result.changed | default(false) else 'No' }}"
