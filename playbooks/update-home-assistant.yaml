---
# DIAGNOSTIC RUN - find correct backup list parsing
# Remove this after confirming the response structure

- name: Debug backup API responses
  hosts: homeassistant
  gather_facts: false

  tasks:
    - name: Check HA API is reachable
      ansible.builtin.uri:
        url: "{{ ha_url }}/api/"
        method: GET
        headers:
          Authorization: "Bearer {{ vault_ha_token }}"
        status_code: 200

    - name: Get backup list via template API
      ansible.builtin.uri:
        url: "{{ ha_url }}/api/template"
        method: POST
        headers:
          Authorization: "Bearer {{ vault_ha_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          template: "{{ '{{' }} states | selectattr('entity_id', 'match', 'sensor.*backup.*') | map(attribute='entity_id') | list | tojson {{ '}}' }}"
        return_content: true
        status_code: 200
      register: backup_sensors

    - name: Show backup-related sensors
      ansible.builtin.debug:
        msg: "Backup sensors found: {{ backup_sensors.content }}"

    - name: Get hassio backups info
      ansible.builtin.uri:
        url: "{{ ha_url }}/api/hassio/backups/info"
        method: GET
        headers:
          Authorization: "Bearer {{ vault_ha_token }}"
        return_content: true
        status_code: 200
      register: hassio_info

    - name: Show hassio backups info - top level keys
      ansible.builtin.debug:
        msg: "Top-level keys: {{ hassio_info.json.keys() | list }}"

    - name: Show hassio backups info - data keys
      ansible.builtin.debug:
        msg: "Data keys: {{ hassio_info.json.data.keys() | list }}"
      when: hassio_info.json.data is defined and hassio_info.json.data is mapping

    - name: Show hassio backups info - backup count and first entry
      ansible.builtin.debug:
        msg: |
          Backup count: {{ hassio_info.json.data.backups | length }}
          {% if hassio_info.json.data.backups | length > 0 %}
          First backup: {{ hassio_info.json.data.backups[0] | to_nice_json }}
          {% endif %}
      when: hassio_info.json.data is defined and hassio_info.json.data.backups is defined

    - name: Show full raw response (first 2000 chars)
      ansible.builtin.debug:
        msg: "{{ hassio_info.content[:2000] }}"
