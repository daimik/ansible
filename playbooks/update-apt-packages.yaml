---
# Ansible Playbook: Weekly Debian/Ubuntu/Proxmox Update
# Works on any Debian-based system. Automatically detects Proxmox VE
# and Proxmox Backup Server, then runs additional checks accordingly.
# Sends Gotify notifications with reboot status per host.
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://8.8.8.8:8011/)
#   gotify_token  - Gotify application token

- name: Weekly update Debian-based systems
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    autoremove_packages: true
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5

  tasks:
    # ──────────────────────────────────────────────
    # 1. Detect Proxmox Products
    # ──────────────────────────────────────────────

    - name: Check if this is a Proxmox VE host
      ansible.builtin.stat:
        path: /usr/bin/pveversion
      register: pve_check

    - name: Check if this is a Proxmox Backup Server
      ansible.builtin.stat:
        path: /usr/bin/proxmox-backup-manager
      register: pbs_check

    - name: Set Proxmox facts
      ansible.builtin.set_fact:
        is_proxmox: "{{ pve_check.stat.exists | bool }}"
        is_pbs: "{{ pbs_check.stat.exists | bool }}"

    # ──────────────────────────────────────────────
    # 2. System Update
    # ──────────────────────────────────────────────

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Check for available upgrades
      ansible.builtin.shell: apt list --upgradable 2>/dev/null | tail -n +2
      register: available_upgrades
      changed_when: false

    - name: Display available upgrades
      ansible.builtin.debug:
        msg: "{{ available_upgrades.stdout_lines | default(['No upgrades available']) }}"

    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        dpkg_options: "force-confdef,force-confold"
      register: upgrade_result
      async: 900
      poll: 30

    # ──────────────────────────────────────────────
    # 3. Cleanup
    # ──────────────────────────────────────────────

    - name: Remove unused dependencies
      ansible.builtin.apt:
        autoremove: true
        purge: true
      when: autoremove_packages

    - name: Clean apt cache
      ansible.builtin.command: apt-get autoclean -y
      register: autoclean_result
      changed_when: autoclean_result.stdout is search('Del ')

    # ──────────────────────────────────────────────
    # 4. Reboot Check
    # ──────────────────────────────────────────────

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot status
      ansible.builtin.debug:
        msg: >-
          {% if reboot_required.stat.exists %}
          REBOOT REQUIRED (likely kernel update) — manual reboot needed
          {% else %}
          No reboot required
          {% endif %}

    # ──────────────────────────────────────────────
    # 5. Proxmox VE Verification (only on PVE hosts)
    # ──────────────────────────────────────────────

    - name: Get current PVE version
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false
      when: is_proxmox

    - name: Check Proxmox VE services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - pvedaemon
        - pveproxy
        - pvestatd
        - pve-cluster
      register: pve_services
      when: is_proxmox

    # ──────────────────────────────────────────────
    # 6. Proxmox Backup Server Verification
    # ──────────────────────────────────────────────

    - name: Get current PBS version
      ansible.builtin.command: proxmox-backup-manager versions
      register: pbs_version
      changed_when: false
      when: is_pbs

    - name: Check Proxmox Backup Server services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - proxmox-backup
        - proxmox-backup-proxy
      register: pbs_services
      when: is_pbs

    - name: Check PBS datastore health
      ansible.builtin.command: proxmox-backup-manager datastore list --output-format json
      register: pbs_datastores
      changed_when: false
      when: is_pbs

    - name: Display PBS datastore info
      ansible.builtin.debug:
        msg: "Datastores configured: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list }}"
      when: is_pbs

    # ──────────────────────────────────────────────
    # 7. Gotify Notifications (sent from remote host)
    # ──────────────────────────────────────────────

    - name: Build Gotify notification body
      ansible.builtin.set_fact:
        _gotify_title: >-
          {{ '⚠️ ' + inventory_hostname + ' — Reboot required'
             if reboot_required.stat.exists
             else '✅ ' + inventory_hostname + ' — Update completed' }}
        _gotify_priority: "{{ 8 if reboot_required.stat.exists else gotify_priority }}"
        _gotify_message: >-
          **Host:** {{ inventory_hostname }}\n
          **IP:** {{ ansible_default_ipv4.address }}\n
          **OS:** {{ ansible_distribution }} {{ ansible_distribution_version }}\n
          {{ '**PVE:** ' + pve_version.stdout + '\\n' if is_proxmox | bool else '' }}
          {{ '**PBS:** ' + pbs_version.stdout_lines[0] + '\\n' if is_pbs | bool else '' }}
          **Packages upgraded:** {{ 'Yes' if upgrade_result.changed else 'No' }}\n
          {{ '**⚠️ Reboot is required — please reboot manually**' if reboot_required.stat.exists else '**No reboot required**' }}

    - name: Send Gotify notification
      ansible.builtin.shell: |
        curl -s -o /dev/null -w "%{http_code}" \
          -X POST "{{ gotify_url }}message" \
          -H "X-Gotify-Key: {{ gotify_token }}" \
          -H "Content-Type: application/json" \
          -d '{
            "title": "{{ _gotify_title | trim }}",
            "message": "{{ _gotify_message | trim }}",
            "priority": {{ _gotify_priority }},
            "extras": {"client::display": {"contentType": "text/markdown"}}
          }'
      register: gotify_response
      changed_when: false
      failed_when: gotify_response.stdout != "200"

    # ──────────────────────────────────────────────
    # 8. Final Status
    # ──────────────────────────────────────────────

    - name: Display final status (Proxmox VE)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PVE Version: {{ pve_version.stdout }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PVE services running: {{ pve_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
      when: is_proxmox

    - name: Display final status (Proxmox Backup Server)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PBS Version: {{ pbs_version.stdout_lines[0] }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PBS services running: {{ pbs_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
          - "Datastores: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list | join(', ') }}"
      when: is_pbs

    - name: Display final status (Debian/Ubuntu)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
      when: not is_proxmox and not is_pbs
