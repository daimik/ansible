---
# Ansible Playbook: Weekly Proxmox VE Host Update
# Keeps your Proxmox hosts fully patched and updated.

- name: Weekly update Proxmox VE hosts
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    auto_reboot: true
    reboot_timeout: 600
    autoremove_packages: true

  tasks:
    # ──────────────────────────────────────────────
    # 1. System Update
    # ──────────────────────────────────────────────

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Check for available upgrades
      ansible.builtin.command: apt list --upgradable
      register: available_upgrades
      changed_when: false

    - name: Display available upgrades
      ansible.builtin.debug:
        msg: "{{ available_upgrades.stdout_lines[1:] | default(['No upgrades available']) }}"

    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        dpkg_options: "force-confdef,force-confold"
      register: upgrade_result

    # ──────────────────────────────────────────────
    # 2. Cleanup
    # ──────────────────────────────────────────────

    - name: Remove unused dependencies
      ansible.builtin.apt:
        autoremove: true
        purge: true
      when: autoremove_packages

    - name: Clean apt cache
      ansible.builtin.apt:
        autoclean: true

    # ──────────────────────────────────────────────
    # 3. Reboot Handling
    # ──────────────────────────────────────────────

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot status
      ansible.builtin.debug:
        msg: >-
          {% if reboot_required.stat.exists %}
          REBOOT REQUIRED (likely kernel update)
          {% else %}
          No reboot required
          {% endif %}

    - name: Reboot host if required
      ansible.builtin.reboot:
        msg: "Ansible: Rebooting after updates"
        pre_reboot_delay: 15
        post_reboot_delay: 30
        reboot_timeout: "{{ reboot_timeout }}"
      when:
        - auto_reboot
        - reboot_required.stat.exists

    - name: Wait for Proxmox API to be available after reboot
      ansible.builtin.uri:
        url: "https://{{ ansible_host }}:8006/api2/json/version"
        validate_certs: false
        status_code: 200
      register: pve_api
      retries: 30
      delay: 10
      until: pve_api.status == 200
      when:
        - auto_reboot
        - reboot_required.stat.exists

    # ──────────────────────────────────────────────
    # 4. Verification
    # ──────────────────────────────────────────────

    - name: Get current PVE version
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false

    - name: Check Proxmox services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - pvedaemon
        - pveproxy
        - pvestatd
        - pve-cluster
      register: services_status

    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "PVE Version: {{ pve_version.stdout }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot performed: {{ 'Yes' if (reboot_required.stat.exists and auto_reboot) else 'No' }}"
          - "All services running: {{ services_status.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
