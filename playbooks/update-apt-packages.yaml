---
# Ansible Playbook: Weekly Debian/Ubuntu/Proxmox Update
# Works on any Debian-based system. Automatically detects Proxmox VE
# and Proxmox Backup Server, then runs additional checks accordingly.

- name: Weekly update Debian-based systems
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    auto_reboot: true
    reboot_timeout: 300
    autoremove_packages: true

  tasks:
    # ──────────────────────────────────────────────
    # 1. Detect Proxmox Products
    # ──────────────────────────────────────────────

    - name: Check if this is a Proxmox VE host
      ansible.builtin.stat:
        path: /usr/bin/pveversion
      register: pve_check

    - name: Check if this is a Proxmox Backup Server
      ansible.builtin.stat:
        path: /usr/bin/proxmox-backup-manager
      register: pbs_check

    - name: Set Proxmox facts
      ansible.builtin.set_fact:
        is_proxmox: "{{ pve_check.stat.exists }}"
        is_pbs: "{{ pbs_check.stat.exists }}"

    # ──────────────────────────────────────────────
    # 2. System Update
    # ──────────────────────────────────────────────

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Check for available upgrades
      ansible.builtin.command: apt list --upgradable
      register: available_upgrades
      changed_when: false

    - name: Display available upgrades
      ansible.builtin.debug:
        msg: "{{ available_upgrades.stdout_lines[1:] | default(['No upgrades available']) }}"

    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        dpkg_options: "force-confdef,force-confold"
      register: upgrade_result

    # ──────────────────────────────────────────────
    # 3. Cleanup
    # ──────────────────────────────────────────────

    - name: Remove unused dependencies
      ansible.builtin.apt:
        autoremove: true
        purge: true
      when: autoremove_packages

    - name: Clean apt cache
      ansible.builtin.apt:
        autoclean: true

    # ──────────────────────────────────────────────
    # 4. Reboot Handling
    # ──────────────────────────────────────────────

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot status
      ansible.builtin.debug:
        msg: >-
          {% if reboot_required.stat.exists %}
          REBOOT REQUIRED (likely kernel update)
          {% else %}
          No reboot required
          {% endif %}

    - name: Reboot host if required
      ansible.builtin.reboot:
        msg: "Ansible: Rebooting after updates"
        pre_reboot_delay: 15
        post_reboot_delay: 30
        reboot_timeout: "{{ reboot_timeout }}"
      when:
        - auto_reboot
        - reboot_required.stat.exists

    # ──────────────────────────────────────────────
    # 5. Proxmox VE Verification (only on PVE hosts)
    # ──────────────────────────────────────────────

    - name: Get current PVE version
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false
      when: is_proxmox

    - name: Check Proxmox VE services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - pvedaemon
        - pveproxy
        - pvestatd
        - pve-cluster
      register: pve_services
      when: is_proxmox

    # ──────────────────────────────────────────────
    # 6. Proxmox Backup Server Verification
    # ──────────────────────────────────────────────

    - name: Get current PBS version
      ansible.builtin.command: proxmox-backup-manager versions
      register: pbs_version
      changed_when: false
      when: is_pbs

    - name: Check Proxmox Backup Server services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - proxmox-backup
        - proxmox-backup-proxy
      register: pbs_services
      when: is_pbs

    - name: Check PBS datastore health
      ansible.builtin.command: proxmox-backup-manager datastore list --output-format json
      register: pbs_datastores
      changed_when: false
      when: is_pbs

    - name: Display PBS datastore info
      ansible.builtin.debug:
        msg: "Datastores configured: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list }}"
      when: is_pbs

    # ──────────────────────────────────────────────
    # 7. Final Status
    # ──────────────────────────────────────────────

    - name: Display final status (Proxmox VE)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PVE Version: {{ pve_version.stdout }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot performed: {{ 'Yes' if (reboot_required.stat.exists and auto_reboot) else 'No' }}"
          - "All PVE services running: {{ pve_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
      when: is_proxmox

    - name: Display final status (Proxmox Backup Server)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PBS Version: {{ pbs_version.stdout_lines[0] }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot performed: {{ 'Yes' if (reboot_required.stat.exists and auto_reboot) else 'No' }}"
          - "All PBS services running: {{ pbs_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
          - "Datastores: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list | join(', ') }}"
      when: is_pbs

    - name: Display final status (Debian/Ubuntu)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot performed: {{ 'Yes' if (reboot_required.stat.exists and auto_reboot) else 'No' }}"
      when: not is_proxmox and not is_pbs
