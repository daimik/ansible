---
# Ansible Playbook: Weekly Debian/Ubuntu/Proxmox Update
# Works on any Debian-based system. Automatically detects Proxmox VE
# and Proxmox Backup Server, then runs additional checks accordingly.
# Sends Gotify notifications with reboot status per host.
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://8.8.8.8:8011/)
#   gotify_token  - Gotify application token

# ================================================================
# Play 1: Update all hosts
# ================================================================
- name: Weekly update Debian-based systems
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    autoremove_packages: true

  tasks:
    # ──────────────────────────────────────────────
    # 1. Detect Proxmox Products
    # ──────────────────────────────────────────────

    - name: Check if this is a Proxmox VE host
      ansible.builtin.stat:
        path: /usr/bin/pveversion
      register: pve_check

    - name: Check if this is a Proxmox Backup Server
      ansible.builtin.stat:
        path: /usr/bin/proxmox-backup-manager
      register: pbs_check

    - name: Set Proxmox facts
      ansible.builtin.set_fact:
        is_proxmox: "{{ pve_check.stat.exists | bool }}"
        is_pbs: "{{ pbs_check.stat.exists | bool }}"

    # ──────────────────────────────────────────────
    # 2. System Update
    # ──────────────────────────────────────────────

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Check for available upgrades
      ansible.builtin.shell: apt list --upgradable 2>/dev/null | tail -n +2
      register: available_upgrades
      changed_when: false

    - name: Display available upgrades
      ansible.builtin.debug:
        msg: "{{ available_upgrades.stdout_lines | default(['No upgrades available']) }}"

    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        dpkg_options: "force-confdef,force-confold"
      register: upgrade_result
      async: 900
      poll: 30

    # ──────────────────────────────────────────────
    # 3. Cleanup
    # ──────────────────────────────────────────────

    - name: Remove unused dependencies
      ansible.builtin.apt:
        autoremove: true
        purge: true
      when: autoremove_packages

    - name: Clean apt cache
      ansible.builtin.command: apt-get autoclean -y
      register: autoclean_result
      changed_when: autoclean_result.stdout is search('Del ')

    # ──────────────────────────────────────────────
    # 4. Reboot Check
    # ──────────────────────────────────────────────

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot status
      ansible.builtin.debug:
        msg: >-
          {% if reboot_required.stat.exists %}
          REBOOT REQUIRED (likely kernel update) — manual reboot needed
          {% else %}
          No reboot required
          {% endif %}

    # ──────────────────────────────────────────────
    # 5. Proxmox VE Verification (only on PVE hosts)
    # ──────────────────────────────────────────────

    - name: Get current PVE version
      ansible.builtin.command: pveversion
      register: pve_version
      changed_when: false
      when: is_proxmox

    - name: Check Proxmox VE services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - pvedaemon
        - pveproxy
        - pvestatd
        - pve-cluster
      register: pve_services
      when: is_proxmox

    # ──────────────────────────────────────────────
    # 6. Proxmox Backup Server Verification
    # ──────────────────────────────────────────────

    - name: Get current PBS version
      ansible.builtin.command: proxmox-backup-manager versions
      register: pbs_version
      changed_when: false
      when: is_pbs

    - name: Check Proxmox Backup Server services status
      ansible.builtin.systemd:
        name: "{{ item }}"
      loop:
        - proxmox-backup
        - proxmox-backup-proxy
      register: pbs_services
      when: is_pbs

    - name: Check PBS datastore health
      ansible.builtin.command: proxmox-backup-manager datastore list --output-format json
      register: pbs_datastores
      changed_when: false
      when: is_pbs

    - name: Display PBS datastore info
      ansible.builtin.debug:
        msg: "Datastores configured: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list }}"
      when: is_pbs

    # ──────────────────────────────────────────────
    # 7. Save results for notification play
    # ──────────────────────────────────────────────

    - name: Store update results as host facts
      ansible.builtin.set_fact:
        _update_results:
          hostname: "{{ inventory_hostname }}"
          ip: "{{ ansible_default_ipv4.address }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          is_proxmox: "{{ is_proxmox }}"
          is_pbs: "{{ is_pbs }}"
          pve_version: "{{ pve_version.stdout | default('') }}"
          pbs_version: "{{ pbs_version.stdout_lines[0] | default('') }}"
          packages_upgraded: "{{ upgrade_result.changed }}"
          reboot_required: "{{ reboot_required.stat.exists }}"
        cacheable: true

    # ──────────────────────────────────────────────
    # 8. Final Status
    # ──────────────────────────────────────────────

    - name: Display final status (Proxmox VE)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PVE Version: {{ pve_version.stdout }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PVE services running: {{ pve_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
      when: is_proxmox

    - name: Display final status (Proxmox Backup Server)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PBS Version: {{ pbs_version.stdout_lines[0] }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PBS services running: {{ pbs_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
          - "Datastores: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list | join(', ') }}"
      when: is_pbs

    - name: Display final status (Debian/Ubuntu)
      ansible.builtin.debug:
        msg:
          - "Host: {{ inventory_hostname }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
      when: not is_proxmox and not is_pbs

# ================================================================
# Play 2: Send Gotify notifications (runs on Semaphore runner)
# ================================================================
- name: Send Gotify notifications
  hosts: all
  gather_facts: false
  become: false
  connection: local
  serial: 1

  vars:
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5

  tasks:
    - name: Send Gotify notification (reboot needed)
      ansible.builtin.uri:
        url: "{{ gotify_url }}message"
        method: POST
        headers:
          X-Gotify-Key: "{{ gotify_token }}"
        body_format: json
        body:
          title: "⚠️ {{ hostvars[inventory_hostname]._update_results.hostname }} — Reboot required"
          message: >-
            **Host:** {{ hostvars[inventory_hostname]._update_results.hostname }}

            **IP:** {{ hostvars[inventory_hostname]._update_results.ip }}

            **OS:** {{ hostvars[inventory_hostname]._update_results.os }}
            {{ '**PVE:** ' + hostvars[inventory_hostname]._update_results.pve_version if hostvars[inventory_hostname]._update_results.is_proxmox | bool else '' }}
            {{ '**PBS:** ' + hostvars[inventory_hostname]._update_results.pbs_version if hostvars[inventory_hostname]._update_results.is_pbs | bool else '' }}

            **Packages upgraded:** {{ 'Yes' if hostvars[inventory_hostname]._update_results.packages_upgraded | bool else 'No' }}

            **⚠️ Reboot is required — please reboot manually**
          priority: 8
          extras:
            client::display:
              contentType: "text/markdown"
        status_code: 200
      when: hostvars[inventory_hostname]._update_results.reboot_required | bool

    - name: Send Gotify notification (no reboot needed)
      ansible.builtin.uri:
        url: "{{ gotify_url }}message"
        method: POST
        headers:
          X-Gotify-Key: "{{ gotify_token }}"
        body_format: json
        body:
          title: "✅ {{ hostvars[inventory_hostname]._update_results.hostname }} — Update completed"
          message: >-
            **Host:** {{ hostvars[inventory_hostname]._update_results.hostname }}

            **IP:** {{ hostvars[inventory_hostname]._update_results.ip }}

            **OS:** {{ hostvars[inventory_hostname]._update_results.os }}
            {{ '**PVE:** ' + hostvars[inventory_hostname]._update_results.pve_version if hostvars[inventory_hostname]._update_results.is_proxmox | bool else '' }}
            {{ '**PBS:** ' + hostvars[inventory_hostname]._update_results.pbs_version if hostvars[inventory_hostname]._update_results.is_pbs | bool else '' }}

            **Packages upgraded:** {{ 'Yes' if hostvars[inventory_hostname]._update_results.packages_upgraded | bool else 'No' }}

            **No reboot required**
          priority: "{{ gotify_priority }}"
          extras:
            client::display:
              contentType: "text/markdown"
        status_code: 200
      when: not (hostvars[inventory_hostname]._update_results.reboot_required | bool)
