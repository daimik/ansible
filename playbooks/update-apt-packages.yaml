---
# Ansible Playbook: Weekly Debian/Ubuntu/Pop!_OS/Proxmox Update
# Works on any apt-based system. Automatically detects Proxmox VE
# and Proxmox Backup Server, then runs additional checks accordingly.
# Sends Gotify notifications with reboot status per host.
#
# Supported: Debian, Ubuntu, Pop!_OS, Proxmox VE, Proxmox Backup Server
#
# Required extra-vars (set in Semaphore Environment):
#   gotify_url    - Gotify server URL (e.g. http://gotify)
#   gotify_token  - Gotify application token

- name: Weekly update apt-based systems
  hosts: all
  become: true
  gather_facts: true
  serial: 1

  vars:
    autoremove_packages: true
    gotify_url: "{{ lookup('env', 'GOTIFY_URL') | default(gotify_url, true) }}"
    gotify_token: "{{ lookup('env', 'GOTIFY_TOKEN') | default(gotify_token, true) }}"
    gotify_priority: 5

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 1. Validate and detect system type
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Verify this is an apt-based system
      ansible.builtin.assert:
        that:
          - ansible_pkg_mgr == 'apt'
        fail_msg: "This playbook only supports apt-based systems. Detected: {{ ansible_pkg_mgr }}"
        success_msg: "{{ ansible_distribution }} {{ ansible_distribution_version }} â€” apt confirmed"

    - name: Check if this is a Proxmox VE host
      ansible.builtin.stat:
        path: /usr/bin/pveversion
      register: pve_check

    - name: Check if this is a Proxmox Backup Server
      ansible.builtin.stat:
        path: /usr/bin/proxmox-backup-manager
      register: pbs_check

    - name: Set system type facts
      ansible.builtin.set_fact:
        is_proxmox: "{{ pve_check.stat.exists | bool }}"
        is_pbs: "{{ pbs_check.stat.exists | bool }}"
        is_pop_os: "{{ ansible_distribution == 'Pop!_OS' }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 2. System Update
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    - name: Check for available upgrades
      ansible.builtin.shell: apt list --upgradable 2>/dev/null | tail -n +2
      register: available_upgrades
      changed_when: false

    - name: Display available upgrades
      ansible.builtin.debug:
        msg: "{{ available_upgrades.stdout_lines | default(['No upgrades available']) }}"

    - name: Perform full system upgrade (dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
        dpkg_options: "force-confdef,force-confold"
      register: upgrade_result
      async: 900
      poll: 30

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 3. Cleanup
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Remove unused dependencies
      ansible.builtin.apt:
        autoremove: true
        purge: true
      when: autoremove_packages

    - name: Clean apt cache
      ansible.builtin.command: apt-get autoclean -y
      register: autoclean_result
      changed_when: autoclean_result.stdout is search('Del ')

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 4. Pop!_OS specific (flatpak updates)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Update Flatpak packages
      ansible.builtin.command: flatpak update -y --noninteractive
      register: flatpak_result
      changed_when: flatpak_result.stdout is search('updating')
      failed_when: false
      when: is_pop_os

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 5. Reboot Check
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Display reboot status
      ansible.builtin.debug:
        msg: >-
          {% if reboot_required.stat.exists %}
          REBOOT REQUIRED (likely kernel update) â€” manual reboot needed
          {% else %}
          No reboot required
          {% endif %}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 6. Proxmox VE Verification
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Proxmox VE checks
      when: is_proxmox
      block:
        - name: Get current PVE version
          ansible.builtin.command: pveversion
          register: pve_version
          changed_when: false

        - name: Check Proxmox VE services status
          ansible.builtin.systemd:
            name: "{{ item }}"
          loop:
            - pvedaemon
            - pveproxy
            - pvestatd
            - pve-cluster
          register: pve_services

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 7. Proxmox Backup Server Verification
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Proxmox Backup Server checks
      when: is_pbs
      block:
        - name: Get current PBS version
          ansible.builtin.command: proxmox-backup-manager versions
          register: pbs_version
          changed_when: false

        - name: Check Proxmox Backup Server services status
          ansible.builtin.systemd:
            name: "{{ item }}"
          loop:
            - proxmox-backup
            - proxmox-backup-proxy
          register: pbs_services

        - name: Check PBS datastore health
          ansible.builtin.command: proxmox-backup-manager datastore list --output-format json
          register: pbs_datastores
          changed_when: false

        - name: Display PBS datastore info
          ansible.builtin.debug:
            msg: "Datastores configured: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 8. Gotify Notifications (sent from Semaphore runner)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Build Gotify notification metadata
      ansible.builtin.set_fact:
        _gotify_title: >-
          {{ 'âš ï¸ ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” Reboot required'
             if reboot_required.stat.exists
             else 'âœ… ' + ansible_hostname + ' (' + ansible_default_ipv4.address + ') â€” Update completed' }}
        _gotify_priority: "{{ 8 if reboot_required.stat.exists else gotify_priority }}"

    - name: Build Gotify message body
      ansible.builtin.set_fact:
        _gotify_message: >-
          ğŸ–¥ï¸ **Host:** {{ ansible_hostname }}\n\nğŸŒ
          **IP:** {{ ansible_default_ipv4.address }}\n\nğŸ·ï¸
          **FQDN:** {{ ansible_fqdn }}\n\nğŸ’»
          **OS:** {{ ansible_distribution }} {{ ansible_distribution_version }}\n\n{{
          'ğŸŸ¢ **PVE:** ' + pve_version.stdout + '\n\n' if is_proxmox | bool else '' }}{{
          'ğŸŸ¢ **PBS:** ' + pbs_version.stdout_lines[0] + '\n\n' if is_pbs | bool else '' }}ğŸ“¦
          **Packages upgraded:** {{ 'Yes' if upgrade_result.changed else 'No' }}{{
          '\n\nğŸ“¦ **Flatpak updated:** ' + ('Yes' if flatpak_result.changed else 'No') if is_pop_os | bool else '' }}\n\n---\n\n{{
          'âš ï¸ **Reboot is required â€” please reboot manually!**' if reboot_required.stat.exists
          else 'âœ… **No reboot required**' }}

    - name: Ensure curl is installed
      ansible.builtin.apt:
        name: curl
        state: present

    - name: Send Gotify notification
      ansible.builtin.shell: |
        cat <<'PAYLOAD' | curl -s -m 15 -o /dev/null -w "%{http_code}" \
          -X POST "{{ gotify_url }}message" \
          -H "X-Gotify-Key: {{ gotify_token }}" \
          -H "Content-Type: application/json" \
          -d @-
        {
          "title": "{{ _gotify_title | trim }}",
          "message": "{{ _gotify_message | trim }}",
          "priority": {{ _gotify_priority }},
          "extras": {"client::display": {"contentType": "text/markdown"}}
        }
        PAYLOAD
      register: gotify_response
      changed_when: false
      failed_when: gotify_response.stdout != "200"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # 9. Final Status
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: Display final status (Proxmox VE)
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PVE Version: {{ pve_version.stdout }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PVE services running: {{ pve_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
      when: is_proxmox

    - name: Display final status (Proxmox Backup Server)
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "PBS Version: {{ pbs_version.stdout_lines[0] }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
          - "All PBS services running: {{ pbs_services.results | map(attribute='status') | map(attribute='ActiveState') | list | unique == ['active'] }}"
          - "Datastores: {{ (pbs_datastores.stdout | from_json) | map(attribute='name') | list | join(', ') }}"
      when: is_pbs

    - name: Display final status (Debian/Ubuntu/Pop!_OS)
      ansible.builtin.debug:
        msg:
          - "Host: {{ ansible_hostname }} ({{ inventory_hostname }})"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Packages upgraded: {{ 'Yes' if upgrade_result.changed else 'No' }}"
          - "{{ 'Flatpak updated: ' + ('Yes' if flatpak_result.changed else 'No') if is_pop_os | bool else '' }}"
          - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
      when: not is_proxmox and not is_pbs
